<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="MainTree">
  <BehaviorTree ID="Auto">
    <Sequence name="AutoSequence">
      <LifecycleManager name="DeactivateManualNode"
                        node_name="manualNode"
                        transition="deactivate"
                        timeout_sec="1"/>
      <Talker name="AutomatickTalker"
              message="Automatick Mode Start"
              topic_name="/talker"/>
      <ResetLocalization service_name="/localization/reset"
                         timeout_sec="2.0"/>
      <LifecycleManager name="ActivateZOHNode"
                        node_name="planner/wrench_planner/zoh_wrench_planner_component"
                        transition="activate"
                        timeout_sec="1"/>
      <Talker name="AutomatickTalker"
              message="Waypoint Action Start"
              topic_name="/talker"/>
      <WaypointAction action_name="planner/pdla_planner/pdla_plan"
                      csv_file_path="assets/sample/latitude_longitude.csv"/>
      <Talker name="AutomatickTalker"
              message="Waypoint Action Successful"
              topic_name="/talker"/>

      <AlwaysRunning name="AutoRunning"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Configure">
    <Delay delay_msec="2000">
      <Sequence name="ConfigureSequence">
        <LifecycleManager name="ConfigureManualNode"
                          node_name="manualNode"
                          transition="configure"
                          timeout_sec="1"/>
        <LifecycleManager name="ConfigureZOHNode"
                          node_name="planner/wrench_planner/zoh_wrench_planner_component"
                          transition="configure"
                          timeout_sec="1"/>
        <LifecycleManager name="ConfigureEmergencyNode"
                          node_name="emergencyNode"
                          transition="configure"
                          timeout_sec="1"/>
      </Sequence>
    </Delay>
  </BehaviorTree>

  <BehaviorTree ID="Emergency">
    <Sequence name="EmergencySequence">
      <Fallback>
        <LifecycleManager name="DeactivateZOHNode"
                          node_name="planner/wrench_planner/zoh_wrench_planner_component"
                          transition="deactivate"
                          timeout_sec="1"/>
        <AlwaysSuccess/>
      </Fallback>
      <Talker name="EmergencyTalker"
              message="Emergency Mode Start"
              topic_name="/talker"/>
      <LifecycleManager name="ActivateEmergencyNode"
                        node_name="emergencyNode"
                        transition="activate"
                        timeout_sec="1"/>
      <AlwaysRunning name="EmergencyRunning"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="MainTree">
    <Delay delay_msec="2000">
      <Sequence>
        <BatteryCheck/>
        <Fallback>
          <Sequence>
            <SubTree ID="Configure"
                     selected_course="{selected_course}"/>
            <ReactiveSequence>
              <RetryUntilSuccessful num_attempts="10">
                <CheckSensorsStatus leak="{leak}"/>
              </RetryUntilSuccessful>
              <UpdateMode topic_name="/joy_common/joy_common"
                          manual_button="circle"
                          auto_button="cross"
                          mode="{mode}"/>
              <Switch2 name="mode_switch"
                       case_1="manual"
                       case_2="auto"
                       variable="{mode}">
                <SubTree ID="Manual"/>
                <SubTree ID="Auto"/>
                <AlwaysFailure/>
              </Switch2>
            </ReactiveSequence>
          </Sequence>
          <SubTree ID="Emergency"/>
        </Fallback>
      </Sequence>
    </Delay>
  </BehaviorTree>

  <BehaviorTree ID="Manual">
    <Sequence name="ManualSequence">
      <Talker name="ManualTalker"
              message="Manual Mode Start"
              topic_name="/talker"/>
      <LifecycleManager name="ActivateManualNode"
                        node_name="manualNode"
                        transition="activate"
                        timeout_sec="1"/>
      <AlwaysRunning name="ManualRunning"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AlwaysRunning"
            editable="true"/>
    <Action ID="BatteryCheck"
            editable="true"/>
    <Action ID="CheckSensorsStatus"
            editable="true">
      <output_port name="leak"/>
    </Action>
    <Action ID="LifecycleManager"
            editable="true">
      <input_port name="node_name"/>
      <input_port name="transition"/>
      <input_port name="timeout_sec"/>
    </Action>
    <Action ID="ResetLocalization"
            editable="true">
      <input_port name="service_name"
                  default="/localization/reset"/>
      <input_port name="timeout_sec"
                  default="1.0"/>
    </Action>
    <Action ID="Talker"
            editable="true">
      <input_port name="message"/>
      <input_port name="topic_name"/>
    </Action>
    <Action ID="UpdateMode"
            editable="true">
      <input_port name="topic_name"/>
      <input_port name="manual_button"/>
      <input_port name="auto_button"/>
      <output_port name="mode"/>
    </Action>
    <Action ID="WaypointAction"
            editable="true">
      <input_port name="action_name"
                  default="planner/pdla_planner/pdla_plan"/>
      <input_port name="csv_file_path"/>
    </Action>
  </TreeNodesModel>

</root>
