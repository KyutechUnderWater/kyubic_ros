<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
  main_tree_to_execute="MainTree">
  <BehaviorTree ID="Auto">
    <Sequence name="AutoSequence">
      <LifecycleManager name="DeactivateManualNode"
        node_name="manualNode"
        transition="deactivate"
        timeout_sec="1" />
      <ResetLocalization service_name="/localization/reset"
        timeout_sec="2.0" />
      <LifecycleManager name="ActivateZOHNode"
        node_name="planner/wrench_planner/wrench_planner_component"
        transition="activate"
        timeout_sec="1" />
      <WaypointAction action_name="planner/pdla_planner/pdla_plan"
        csv_file_path="assets/kobe/gate_path.csv" />
      <QrAction action_name="/planner/qr_planner/qr_plan" />
      <Switch2 name="Outbound_Selector"
        case_1="A"
        case_2="B"
        variable="{selected_course}">
        <WaypointAction name="Go_Right"
          action_name="planner/pdla_planner/pdla_plan"
          csv_file_path="assets/kobe/right.csv" />
        <WaypointAction name="Go_Left"
          action_name="planner/pdla_planner/pdla_plan"
          csv_file_path="assets/kobe/left.csv" />
        <AlwaysFailure name="Invalid_Course_Selection" />
      </Switch2>
      <FindPingerAction action_name="find_pinger" />
      <Switch2 name="Inbound_Selector"
        case_1="A"
        case_2="B"
        variable="{selected_course}">
        <WaypointAction name="Return_Right"
          action_name="planner/pdla_planner/pdla_plan"
          csv_file_path="assets/kobe/return_right.csv" />
        <WaypointAction name="Return_Left"
          action_name="planner/pdla_planner/pdla_plan"
          csv_file_path="assets/kobe/return_left.csv" />
        <AlwaysFailure name="Invalid_Course_Selection" />
      </Switch2>
      <AlwaysRunning name="AutoRunning" />
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Configure">
    <Delay delay_msec="2000">
      <Sequence name="ConfigureSequence">
        <SetBlackboard value="B"
          output_key="selected_course" />
        <LifecycleManager name="ConfigureManualNode"
          node_name="manualNode"
          transition="configure"
          timeout_sec="1" />
        <LifecycleManager name="ConfigureZOHNode"
          node_name="planner/wrench_planner/wrench_planner_component"
          transition="configure"
          timeout_sec="1" />
        <LifecycleManager name="ConfigureEmergencyNode"
          node_name="emergencyNode"
          transition="configure"
          timeout_sec="1" />
      </Sequence>
    </Delay>
  </BehaviorTree>

  <BehaviorTree ID="Emergency">
    <Sequence name="EmergencySequence">
      <LifecycleManager name="DeactivateZOHNode"
        node_name="planner/wrench_planner/wrench_planner_component"
        transition="deactivate"
        timeout_sec="1" />
      <LifecycleManager name="ActivateEmergencyNode"
        node_name="emergencyNode"
        transition="activate"
        timeout_sec="1" />
      <AlwaysRunning name="EmergencyRunning" />
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="MainTree">
    <Delay delay_msec="2000">
      <Sequence>
        <BatteryCheck />
        <Fallback>
          <Sequence>
            <SubTree ID="Configure"
              selected_course="{selected_course}" />
            <ReactiveSequence>
              <RetryUntilSuccessful num_attempts="10">
                <CheckSensorsStatus leak="{leak}" />
              </RetryUntilSuccessful>
              <UpdateMode topic_name="/joy_common/joy_common"
                manual_button="circle"
                auto_button="cross"
                mode="{mode}" />
              <Switch2 name="mode_switch"
                case_1="manual"
                case_2="auto"
                variable="{mode}">
                <SubTree ID="Manual" />
                <SubTree ID="Auto"
                  selected_course="{selected_course}" />
                <AlwaysFailure />
              </Switch2>
            </ReactiveSequence>
          </Sequence>
          <SubTree ID="Emergency" />
        </Fallback>
      </Sequence>
    </Delay>
  </BehaviorTree>

  <BehaviorTree ID="Manual">
    <Sequence name="ManualSequence">
      <LifecycleManager name="ActivateManualNode"
        node_name="manualNode"
        transition="activate"
        timeout_sec="1" />
      <AlwaysRunning name="ManualRunning" />
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AlwaysRunning"
      editable="true" />
    <Action ID="BatteryCheck"
      editable="true" />
    <Action ID="CheckSensorsStatus"
      editable="true">
      <output_port name="leak" />
    </Action>
    <Action ID="FindPingerAction"
      editable="true">
      <input_port name="action_name"
        default="find_pinger" />
    </Action>
    <Action ID="LifecycleManager"
      editable="true">
      <input_port name="node_name" />
      <input_port name="transition" />
      <input_port name="timeout_sec" />
    </Action>
    <Action ID="QrAction"
      editable="true">
      <input_port name="action_name"
        default="qr_action" />
    </Action>
    <Action ID="ResetLocalization"
      editable="true">
      <input_port name="service_name"
        default="/localization/reset" />
      <input_port name="timeout_sec"
        default="1.0" />
    </Action>
    <Action ID="UpdateMode"
      editable="true">
      <input_port name="topic_name" />
      <input_port name="manual_button" />
      <input_port name="auto_button" />
      <output_port name="mode" />
    </Action>
    <Action ID="WaypointAction"
      editable="true">
      <input_port name="action_name"
        default="planner/pdla_planner/pdla_plan" />
      <input_port name="csv_file_path" />
    </Action>
  </TreeNodesModel>

</root>
