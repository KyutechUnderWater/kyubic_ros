<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
  main_tree_to_execute="MainTree">

  <BehaviorTree ID="Auto">
    <Sequence name="AutoSequence">
      <LifecycleManager name="DeactivateManualNode"
        node_name="manualNode"
        transition="deactivate"
        timeout_sec="1" />
      <ResetLocalization service_name="/localization/reset" timeout_sec="2.0" />
      <WaypointAction action_name="pdla_plan"
        csv_file_path="assets/kobe/gate_path.csv" />
      <QrAction action_name="qr_action" />
      <FindPingerAction action_name="find_pinger" />
      <ReturnAction action_name="return_action" />
      <AlwaysRunning name="AutoRunning" />
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Configure">
    <Delay delay_msec="2000">
      <Sequence name="ConfigureSequence">
        <LifecycleManager name="ConfigureManualNode"
          node_name="manualNode"
          transition="configure"
          timeout_sec="1" />
        <LifecycleManager name="ConfigureEmergencyNode"
          node_name="emergencyNode"
          transition="configure"
          timeout_sec="1" />
      </Sequence>
    </Delay>
  </BehaviorTree>

  <BehaviorTree ID="Emergency">
    <Sequence name="EmergencySequence">
      <LifecycleManager name="ActivateEmergencyNode"
        node_name="emergencyNode"
        transition="activate"
        timeout_sec="1" />
      <AlwaysRunning name="EmergencyRunning" />
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="MainTree">
    <Fallback>
      <Sequence>
        <SubTree ID="Configure" />
        <ReactiveSequence>
          <RetryUntilSuccessful num_attempts="10">
            <CheckSensorsStatus leak="{leak}" />
          </RetryUntilSuccessful>
          <UpdateMode topic_name="/joy_common/joy_common"
            manual_button="circle"
            auto_button="cross"
            mode="{mode}" />
          <Switch2 name="mode_switch"
            case_1="manual"
            case_2="auto"
            variable="{mode}">
            <SubTree ID="Manual" />
            <SubTree ID="Auto" />
            <AlwaysFailure />
          </Switch2>
        </ReactiveSequence>
      </Sequence>
      <SubTree ID="Emergency" />
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="Manual">
    <Sequence name="ManualSequence">
      <LifecycleManager name="ActivateManualNode"
        node_name="manualNode"
        transition="activate"
        timeout_sec="1" />
      <AlwaysRunning name="ManualRunning" />
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AlwaysRunning"
      editable="true" />
    <Action ID="CheckSensorsStatus"
      editable="true">
      <output_port name="leak" />
    </Action>
    <Action ID="LifecycleManager"
      editable="true">
      <input_port name="node_name" />
      <input_port name="transition" />
      <input_port name="timeout_sec" />
    </Action>
    <Action ID="QrAction"
      editable="true">
      <input_port name="action_name"
        default="qr_action" />
    </Action>
    <Action ID="UpdateMode"
      editable="true">
      <input_port name="topic_name" />
      <input_port name="manual_button" />
      <input_port name="auto_button" />
      <output_port name="mode" />
    </Action>
    <Action ID="ResetLocalization" editable="true">
      <input_port name="service_name" default="/localization/reset" />
      <input_port name="timeout_sec" default="1.0" />
    </Action>
    <Action ID="WaypointAction" editable="true">
      <input_port name="action_name" default="pdla_plan" />
      <input_port name="csv_file_path" />
      <output_port name="current_index" />
    </Action>
    <Action ID="QrAction" editable="true">
      <input_port name="action_name" default="qr_action" />
      <output_port name="target_x" />
      <output_port name="target_y" />
      <output_port name="target_z" />
      <output_port name="confidence" />
    </Action>
    <Action ID="FindPingerAction" editable="true">
      <input_port name="action_name" default="find_pinger" />
      <output_port name="current_yaw" />
      <output_port name="current_score" />
    </Action>
    <Action ID="ReturnAction" editable="true">
      <input_port name="action_name" default="return_action" />
      <input_port name="surface_depth" default="0.0" />
      <input_port name="xy_tolerance" default="0.1" />
      <input_port name="depth_tolerance" default="0.01" />
    </Action>
  </TreeNodesModel>

</root>
